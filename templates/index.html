<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSense AI | Farm OS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <!-- WELCOME MODAL -->
    <div id="welcomeModal" class="modal-overlay">
        <div class="modal-card center-card animate-pop">
            <div class="modal-icon"><i class="fa-solid fa-wheat-awn"></i></div>
            <h2>Welcome to AgriSense AI</h2>
            <p>Your professional farm management workspace.</p>
            <!-- ADDED: onkeydown to handle Enter key -->
            <input type="text" id="farmerNameInput" class="big-input" placeholder="Enter your name" autocomplete="off" onkeydown="handleWelcomeEnter(event)">
            <button onclick="setupApp()" class="btn-primary">Enter Dashboard <i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>

    <!-- ADD TASK MODAL -->
    <div id="taskModal" class="modal-overlay" style="display:none;">
        <div class="modal-card form-card animate-slide-up">
            <div class="modal-header">
                <h3>New Task</h3>
                <button onclick="closeModal('taskModal')" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form onsubmit="saveTask(event)">
                <div class="input-group">
                    <label>Task Description</label>
                    <input type="text" name="desc" placeholder="e.g., Spray pesticides" required>
                </div>
                <div class="input-group">
                    <label>Due Date</label>
                    <input type="date" name="date" required>
                </div>
                <button type="submit" class="btn-primary full-width">Add Task</button>
            </form>
        </div>
    </div>

    <!-- ADD INVENTORY MODAL -->
    <div id="inventoryModal" class="modal-overlay" style="display:none;">
        <div class="modal-card form-card animate-slide-up">
            <div class="modal-header">
                <h3>Add Inventory Item</h3>
                <button onclick="closeModal('inventoryModal')" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form onsubmit="saveInventory(event)">
                <div class="input-group">
                    <label>Item Name</label>
                    <input type="text" name="name" placeholder="e.g., Urea Bags" required>
                </div>
                <div class="input-group">
                    <label>Category</label>
                    <select name="category">
                        <option value="Fertilizer">Fertilizer</option>
                        <option value="Seeds">Seeds</option>
                        <option value="Tools">Tools</option>
                        <option value="Fuel">Fuel</option>
                        <option value="Harvest">Harvest</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Quantity</label>
                    <input type="number" name="qty" placeholder="0" required>
                </div>
                <button type="submit" class="btn-primary full-width">Save Item</button>
            </form>
        </div>
    </div>

    <!-- LOG EXPENSE MODAL -->
    <div id="expenseModal" class="modal-overlay" style="display:none;">
        <div class="modal-card form-card animate-slide-up">
            <div class="modal-header">
                <h3>Log Expense</h3>
                <button onclick="closeModal('expenseModal')" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form onsubmit="saveExpense(event)">
                <div class="input-group">
                    <label>Description</label>
                    <input type="text" name="desc" placeholder="e.g., Tractor Repair" required>
                </div>
                <div class="input-group">
                    <label>Category</label>
                    <select name="category">
                        <option value="Maintenance">Maintenance</option>
                        <option value="Seeds">Seeds</option>
                        <option value="Labor">Labor</option>
                        <option value="Fuel">Fuel</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Amount ($)</label>
                    <input type="number" name="amount" step="0.01" placeholder="0.00" required>
                </div>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" name="date" required>
                </div>
                <button type="submit" class="btn-primary full-width">Log Expense</button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fa-solid fa-leaf text-green"></i> <span>AgriSense AI</span>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-label">MAIN</div>
                <button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fa-solid fa-grid-2"></i> Dashboard</button>
                <button class="nav-btn" onclick="switchTab('inventory')"><i class="fa-solid fa-boxes-stacked"></i> Inventory</button>
                <button class="nav-btn" onclick="switchTab('finances')"><i class="fa-solid fa-wallet"></i> Expenses</button>
                <button class="nav-btn" onclick="switchTab('planner')"><i class="fa-solid fa-calendar-days"></i> Planner</button>

                <div class="nav-label">INTELLIGENCE</div>
                <button class="nav-btn" onclick="switchTab('suggestions')"><i class="fa-solid fa-plant-wilt"></i> Crop Suggestions</button>
                <button class="nav-btn" onclick="switchTab('predict')"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Predictor</button>
                <button class="nav-btn" onclick="switchTab('rainfall')"><i class="fa-solid fa-cloud-showers-heavy"></i> Rain Radar</button>
                <button class="nav-btn" onclick="switchTab('chat')"><i class="fa-solid fa-robot"></i> Soil Doctor</button>
            </nav>

            <div class="sidebar-footer">
                <button class="theme-toggle" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i> <span>Dark Mode</span></button>
                <button class="logout-btn" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
                <div class="user-card">
                    <div class="avatar">F</div>
                    <div class="info"><h4 id="displayFarmerName">Farmer</h4><span class="role-badge">Premium Member</span></div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="content-area">
            
            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <header class="top-bar animate-fade-down">
                    <div>
                        <h1 id="greeting">Hello!</h1>
                        <p class="subtitle"><i class="fa-solid fa-location-dot text-green"></i> <span id="locationName">Loading...</span> <button onclick="changeLocation()" class="edit-loc-btn">Edit</button></p>
                    </div>
                    <div class="date-badge" id="currentDate">--</div>
                </header>

                <div class="seasonal-tip-card animate-fade-down" style="animation-delay: 0.1s;">
                    <div class="tip-icon">üí°</div>
                    <div class="tip-content">
                        <h3>Tip for December</h3>
                        <p>Winter is here! Ensure your wheat crops get their first irrigation (CRI stage) if 21 days have passed since sowing. Protect vegetables from frost.</p>
                    </div>
                </div>

                <div class="weather-strip animate-fade-down" style="animation-delay: 0.2s;" id="weatherContainer">
                    <div class="weather-card loading"><i class="fa-solid fa-circle-notch fa-spin"></i> <p>Syncing Data...</p></div>
                </div>

                <div class="dashboard-grid">
                    <div class="mgmt-card task-section animate-scale-up" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3><i class="fa-solid fa-calendar-check"></i> Tasks</h3>
                            <button onclick="openModal('taskModal')" class="icon-btn"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="mini-calendar">
                            <div class="calendar-header">
                                <span id="calMonthYear">December 2025</span>
                                <div class="cal-arrows"><i class="fa-solid fa-chevron-left"></i> <i class="fa-solid fa-chevron-right"></i></div>
                            </div>
                            <div class="calendar-days" id="calendarDays"></div>
                        </div>
                        <div id="taskList" class="task-list"></div>
                    </div>
                    
                    <div class="mgmt-card highlight-card animate-scale-up" style="animation-delay: 0.4s;">
                        <div class="card-header"><h3><i class="fa-solid fa-wallet"></i> Finances</h3></div>
                        <div class="finance-preview">
                            <div class="preview-item"><span class="label">Total Spend</span><h2 id="dashTotalExpense">$0.00</h2></div>
                        </div>
                        <div class="chart-container-mini"><canvas id="miniExpenseChart"></canvas></div>
                        <div class="quick-link-box"><p class="text-sm text-sub">Top Category: <span id="dashTopCat" class="fw-bold">--</span></p></div>
                    </div>

                    <div class="mgmt-card alert-card animate-scale-up" style="animation-delay: 0.5s;">
                        <div class="card-header"><h3><i class="fa-solid fa-boxes-stacked"></i> Inventory</h3></div>
                        <div id="inventoryAlertBox" class="alert-status healthy">
                            <div class="icon-box"><i class="fa-solid fa-check"></i></div>
                            <div><h4 id="invAlertTitle">Stock Healthy</h4><span id="invAlertDesc">No items running low.</span></div>
                        </div>
                        <div class="recent-items-list" id="recentItemsList"><p class="empty-text">No recent items.</p></div>
                        <button onclick="switchTab('inventory')" class="btn-text">View Full Inventory <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- INVENTORY TAB -->
            <div id="inventory" class="tab-content">
                <header class="top-bar"><div><h1>Inventory</h1><p class="subtitle">Track stock levels.</p></div><button onclick="openModal('inventoryModal')" class="btn-primary small"><i class="fa-solid fa-plus"></i> Add Item</button></header>
                <div class="mgmt-card full-table-card animate-scale-up">
                    <table class="data-table">
                        <thead><tr><th>Item Name</th><th>Category</th><th>Stock Level</th><th>Status</th><th style="text-align: right;">Actions</th></tr></thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- FINANCES TAB -->
            <div id="finances" class="tab-content">
                <header class="top-bar"><div><h1>Expenses</h1><p class="subtitle">Analyze spending.</p></div><button onclick="openModal('expenseModal')" class="btn-primary small"><i class="fa-solid fa-receipt"></i> Log Expense</button></header>
                <div class="finance-grid animate-scale-up">
                    <div class="mgmt-card chart-card"><div class="card-header"><h3>Breakdown</h3></div><div class="chart-wrapper"><canvas id="expenseChart"></canvas></div></div>
                    <div class="mgmt-card history-card"><div class="card-header"><h3>Transactions</h3></div><div class="table-scroll"><table class="data-table"><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th></th></tr></thead><tbody id="expenseTable"></tbody></table></div></div>
                </div>
            </div>

            <!-- PLANNER TAB -->
            <div id="planner" class="tab-content">
                <header class="top-bar"><h1>Season Planner</h1><p class="subtitle">Upcoming tasks & alerts.</p></header>
                <div class="planner-container animate-scale-up">
                    <div class="planner-card">
                        <div class="planner-month">DECEMBER</div>
                        <div class="planner-task">Wheat Irrigation</div>
                        <div class="planner-desc">Critical Root Initiation (CRI) stage. Irrigate 21 days after sowing.</div>
                    </div>
                    <div class="planner-card">
                        <div class="planner-month">JANUARY</div>
                        <div class="planner-task">Late Wheat Sowing</div>
                        <div class="planner-desc">Last chance for sowing late varieties like PBW-373.</div>
                    </div>
                    <div class="planner-card">
                        <div class="planner-month">FEBRUARY</div>
                        <div class="planner-task">Mustard Harvesting</div>
                        <div class="planner-desc">Watch for maturity signs (yellow pods). Prepare for harvest.</div>
                    </div>
                </div>
            </div>

            <!-- CROP SUGGESTIONS TAB -->
            <div id="suggestions" class="tab-content">
                <header class="top-bar"><h1>Crop Suggestions</h1><p class="subtitle">Select your soil type to see recommended crops.</p></header>
                
                <div class="soil-grid animate-scale-up">
                    <div class="soil-card" onclick="showSuggestion('clay')"><span class="soil-icon">üß±</span><span class="soil-name">Clay Soil</span></div>
                    <div class="soil-card" onclick="showSuggestion('loamy')"><span class="soil-icon">üå±</span><span class="soil-name">Loamy Soil</span></div>
                    <div class="soil-card" onclick="showSuggestion('sandy')"><span class="soil-icon">üèúÔ∏è</span><span class="soil-name">Sandy Soil</span></div>
                    <div class="soil-card" onclick="showSuggestion('black')"><span class="soil-icon">üåë</span><span class="soil-name">Black Soil</span></div>
                    <div class="soil-card" onclick="showSuggestion('red')"><span class="soil-icon">üî¥</span><span class="soil-name">Red Soil</span></div>
                </div>

                <div id="suggestionResult" class="suggestion-panel animate-fade-down" style="display:none;">
                    <div class="suggestion-header">
                        <h2 id="soilTitle">Best Crops</h2>
                        <button onclick="closeSuggestion()" class="icon-btn"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="crop-grid" id="cropList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- PREDICTOR TAB -->
            <div id="predict" class="tab-content">
                <header class="top-bar"><h1>Crop Intelligence</h1></header>
                <div class="split-view animate-scale-up">
                    <div class="form-container">
                        <div class="example-section">
                            <span class="example-label">Load Example Data:</span>
                            <div class="example-pills">
                                <button type="button" class="example-chip" onclick="fillExample('rice')">üåæ Rice</button>
                                <button type="button" class="example-chip" onclick="fillExample('coffee')">‚òï Coffee</button>
                                <button type="button" class="example-chip" onclick="fillExample('beans')">ü´ò Kidney Beans</button>
                            </div>
                        </div>
                        <form id="predictForm" onsubmit="handlePredict(event)">
                            <div class="grid-2">
                                <div class="input-wrap"><label>Nitrogen (N)</label><input type="number" name="N" required></div>
                                <div class="input-wrap"><label>Phosphorus (P)</label><input type="number" name="P" required></div>
                                <div class="input-wrap"><label>Potassium (K)</label><input type="number" name="K" required></div>
                                <div class="input-wrap"><label>Temp (¬∞C)</label><input type="number" name="temperature" required></div>
                                <div class="input-wrap"><label>Humidity (%)</label><input type="number" name="humidity" required></div>
                                <div class="input-wrap"><label>pH Level</label><input type="number" name="ph" step="0.1" required></div>
                                <div class="input-wrap full"><label>Rainfall (mm)</label><input type="number" name="rainfall" required></div>
                            </div>
                            <button type="submit" class="btn-primary big">Analyze Soil <div id="loader" class="spinner"></div></button>
                        </form>
                    </div>
                    <div class="result-display" id="resultCard">
                        <div class="empty-state"><i class="fa-solid fa-flask"></i><p>Awaiting data...</p></div>
                        <div class="success-state" style="display:none;"><span class="tag">Result</span><h2 id="predictionResult">--</h2></div>
                    </div>
                </div>
            </div>

            <!-- RAINFALL TAB -->
            <div id="rainfall" class="tab-content">
                <header class="top-bar"><h1>Rainfall Radar</h1></header>
                <div class="rain-grid animate-scale-up" id="rainGrid"></div>
            </div>

            <!-- CHAT TAB WITH IMAGE UPLOAD -->
            <div id="chat" class="tab-content">
                <div class="chat-layout animate-scale-up">
                    <div class="chat-header"><h3>Soil Doctor AI</h3></div>
                    <div class="chat-messages" id="chatWindow"><div class="message bot"><p>How can I help your farm today? Upload a photo of your crop for disease diagnosis.</p></div></div>
                    
                    <!-- Preview Area -->
                    <div id="imagePreviewContainer" class="image-preview-container" style="display:none;"></div>

                    <div class="chat-input">
                        <label for="imgUpload" class="file-upload-label"><i class="fa-solid fa-paperclip"></i></label>
                        <input type="file" id="imgUpload" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <!-- CHANGED: onkeydown to handle Enter -->
                        <input type="text" id="chatInput" placeholder="Ask anything..." onkeydown="handleEnter(event)">
                        <button onclick="sendMessage()" class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA STORE ---
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let expenseChartInstance = null;
        let selectedImage = null; // Store base64 image

        // --- AUTH & INIT ---
        function setupApp() {
            const name = document.getElementById('farmerNameInput').value;
            if(name) { localStorage.setItem('farmerName', name); location.reload(); }
        }
        function handleLogout() { localStorage.clear(); location.reload(); }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        // NEW: Handle Enter for Welcome Screen
        function handleWelcomeEnter(e) {
            if(e.key === 'Enter') setupApp();
        }

        window.onload = function() {
            const name = localStorage.getItem('farmerName');
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

            if (name) {
                document.getElementById('displayFarmerName').innerText = name;
                document.getElementById('greeting').innerText = `Welcome back, ${name}`;
                document.getElementById('welcomeModal').style.display = 'none';
                
                const city = localStorage.getItem('preferredCity');
                if(city) fetchWeatherByCity(city); else fetchWeatherByGeo();
                
                renderTasks(); renderInventory(); renderExpenses(); updateCharts(); checkInventoryHealth(); renderCalendar();
            } else {
                document.getElementById('welcomeModal').style.display = 'flex';
            }
            const d = new Date();
            document.getElementById('currentDate').innerText = d.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- CROP SUGGESTIONS ---
        function showSuggestion(soilType) {
            const panel = document.getElementById('suggestionResult');
            const title = document.getElementById('soilTitle');
            const list = document.getElementById('cropList');
            document.querySelectorAll('.soil-card').forEach(c => c.classList.remove('active'));
            panel.style.display = 'block';
            
            let crops = [];
            if(soilType === 'clay') {
                title.innerText = "Best Crops for Clay Soil";
                crops = [
                    {name: "Rice", icon: "üåæ", desc: "Thrives in the water-retentive properties of clay. Requires flooded fields.", season: "Kharif", water: "High", duration: "120 Days"},
                    {name: "Lettuce", icon: "ü•¨", desc: "Leafy greens love the cool, moist conditions clay provides.", season: "Winter", water: "Medium", duration: "60 Days"},
                    {name: "Broccoli", icon: "ü•¶", desc: "Strong root systems handle the heavy soil structure well.", season: "Rabi", water: "Medium", duration: "90 Days"},
                    {name: "Sunflower", icon: "üåª", desc: "Can tolerate the moisture and density of clay soils.", season: "Summer", water: "Low", duration: "100 Days"}
                ];
            } else if(soilType === 'loamy') {
                title.innerText = "Best Crops for Loamy Soil";
                crops = [
                    {name: "Wheat", icon: "üåæ", desc: "The perfect balance of drainage and nutrients for grain formation.", season: "Rabi", water: "Medium", duration: "140 Days"},
                    {name: "Sugarcane", icon: "üéã", desc: "Requires fertile, well-drained soil for maximum sugar content.", season: "Year-round", water: "High", duration: "12 Months"},
                    {name: "Cotton", icon: "‚òÅÔ∏è", desc: "Grows best in deep, friable loam which allows root expansion.", season: "Kharif", water: "Medium", duration: "160 Days"},
                    {name: "Tomato", icon: "üçÖ", desc: "Needs the rich nutrients found in loamy texture.", season: "All", water: "Medium", duration: "70 Days"}
                ];
            } else if(soilType === 'sandy') {
                title.innerText = "Best Crops for Sandy Soil";
                crops = [
                    {name: "Carrots", icon: "ü•ï", desc: "Roots penetrate easily without obstruction, resulting in straight veggies.", season: "Winter", water: "Medium", duration: "80 Days"},
                    {name: "Watermelon", icon: "üçâ", desc: "Loves warm, quick-draining soil to prevent rot.", season: "Zaid", water: "Medium", duration: "90 Days"},
                    {name: "Peanuts", icon: "ü•ú", desc: "Needs loose soil for 'pegging' (entering the ground).", season: "Kharif", water: "Low", duration: "100 Days"},
                    {name: "Zucchini", icon: "ü•í", desc: "Thrives in the warmth that sandy soil retains.", season: "Summer", water: "Medium", duration: "50 Days"}
                ];
            } else if(soilType === 'black') {
                title.innerText = "Best Crops for Black Soil";
                crops = [
                    {name: "Cotton", icon: "‚òÅÔ∏è", desc: "Also known as 'Black Cotton Soil'. Self-ploughing nature helps roots.", season: "Kharif", water: "Low", duration: "160 Days"},
                    {name: "Soybean", icon: "ü´ò", desc: "Thrives in the high moisture retention of black soil.", season: "Kharif", water: "Medium", duration: "90 Days"},
                    {name: "Sorghum", icon: "üåæ", desc: "Hardy crop that utilizes stored moisture efficiently.", season: "Kharif", water: "Low", duration: "110 Days"},
                    {name: "Chickpea", icon: "ü•£", desc: "Excellent winter crop for this soil type.", season: "Rabi", water: "Low", duration: "100 Days"}
                ];
            } else if(soilType === 'red') {
                title.innerText = "Best Crops for Red Soil";
                crops = [
                    {name: "Groundnut", icon: "ü•ú", desc: "Grows well in the porous, iron-rich structure.", season: "Kharif", water: "Medium", duration: "120 Days"},
                    {name: "Potato", icon: "ü•î", desc: "Tubers develop well in this loose, aerated soil.", season: "Rabi", water: "Medium", duration: "90 Days"},
                    {name: "Ragi", icon: "üåæ", desc: "Excellent for millet cultivation in dry regions.", season: "Kharif", water: "Low", duration: "100 Days"},
                    {name: "Mango", icon: "ü•≠", desc: "Fruit trees adapt well to deep red soils.", season: "Perennial", water: "Medium", duration: "Yearly"}
                ];
            }

            list.innerHTML = '';
            crops.forEach(c => {
                list.innerHTML += `
                    <div class="crop-card animate-scale-up">
                        <div class="crop-card-header">
                            <div class="crop-icon-large">${c.icon}</div>
                            <div>
                                <h4>${c.name}</h4>
                                <div class="crop-tags">
                                    <span class="crop-tag tag-season"><i class="fa-regular fa-calendar"></i> ${c.season}</span>
                                </div>
                            </div>
                        </div>
                        <p class="crop-desc">${c.desc}</p>
                        <div class="crop-meta">
                            <span class="crop-tag tag-water"><i class="fa-solid fa-droplet"></i> ${c.water} Water</span>
                            <span class="crop-tag tag-duration"><i class="fa-solid fa-clock"></i> ${c.duration}</span>
                        </div>
                    </div>
                `;
            });
        }

        function closeSuggestion() { document.getElementById('suggestionResult').style.display = 'none'; }

        // --- FILL EXAMPLE ---
        function fillExample(crop) {
            const data = crop === 'rice' ? { N: 90, P: 42, K: 43, temperature: 21, humidity: 82, ph: 6.5, rainfall: 203 } :
                         crop === 'coffee' ? { N: 100, P: 20, K: 30, temperature: 25, humidity: 60, ph: 6.0, rainfall: 150 } :
                         { N: 20, P: 60, K: 20, temperature: 20, humidity: 22, ph: 5.7, rainfall: 105 };
            for(let k in data) document.querySelector(`[name="${k}"]`).value = data[k];
        }

        // --- IMAGE HANDLING ---
        function handleImageSelect(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImage = e.target.result.split(',')[1];
                const container = document.getElementById('imagePreviewContainer');
                container.style.display = 'flex';
                container.innerHTML = `<img src="${e.target.result}" class="img-preview">`;
            };
            reader.readAsDataURL(file);
        }

        // --- CHAT WITH IMAGE ---
        async function sendMessage() {
            const inp = document.getElementById('chatInput');
            const txt = inp.value.trim();
            if(!txt && !selectedImage) return;

            const win = document.getElementById('chatWindow');
            let contentHtml = `<div class="message user">`;
            if(selectedImage) {
                const imgSrc = `data:image/jpeg;base64,${selectedImage}`;
                contentHtml += `<img src="${imgSrc}" style="max-width: 150px; border-radius: 8px; display: block; margin-bottom: 5px;">`;
                contentHtml += `<p><i>[Image Uploaded]</i></p>`;
            }
            if(txt) contentHtml += `<p>${txt}</p>`;
            contentHtml += `</div>`;
            
            win.innerHTML += contentHtml;
            inp.value = '';
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('imagePreviewContainer').innerHTML = '';
            win.scrollTop = win.scrollHeight;

            try {
                const payload = { question: txt };
                if(selectedImage) { payload.image = selectedImage; selectedImage = null; }
                const res = await fetch('/ask-ai', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                win.innerHTML += `<div class="message bot"><p>${data.answer}</p></div>`;
            } catch(e) {
                win.innerHTML += `<div class="message bot"><p>Error connecting to Soil Doctor.</p></div>`;
            }
            win.scrollTop = win.scrollHeight;
        }

        // --- UTILS (Calendar, Inventory, etc. same as before) ---
        function renderCalendar(){const c=document.getElementById('calendarDays');const n=new Date();const y=n.getFullYear();const m=n.getMonth();const f=new Date(y,m,1).getDay();const d=new Date(y,m+1,0).getDate();const mn=["January","February","March","April","May","June","July","August","September","October","November","December"];document.getElementById('calMonthYear').innerText=`${mn[m]} ${y}`;c.innerHTML='';for(let i=0;i<f;i++)c.innerHTML+=`<div class="cal-day empty"></div>`;for(let i=1;i<=d;i++){const a=i===n.getDate()?'active':'';c.innerHTML+=`<div class="cal-day ${a}">${i}</div>`;}}
        function renderInventory(){const t=document.getElementById('inventoryTable');t.innerHTML='';const s=document.getElementById('recentItemsList');s.innerHTML='';if(inventory.length===0){t.innerHTML=`<tr class="empty-row"><td colspan="5"><div class="empty-state-table"><p>Inventory is empty.</p></div></td></tr>`;return;}inventory.forEach((i,x)=>{let b=i.qty<5?'danger':'success';let st=i.qty<5?'Low Stock':'In Stock';t.innerHTML+=`<tr><td class="fw-bold">${i.name}</td><td>${i.category}</td><td><div class="qty-wrapper"><button onclick="updateStock(${x},-1)" class="qty-btn"><i class="fa-solid fa-minus"></i></button><span>${i.qty}</span><button onclick="updateStock(${x},1)" class="qty-btn"><i class="fa-solid fa-plus"></i></button></div></td><td><span class="badge ${b}">${st}</span></td><td class="text-right"><button onclick="deleteInventory(${x})" class="icon-btn-sm trash"><i class="fa-solid fa-trash"></i></button></td></tr>`;if(x<3)s.innerHTML+=`<div class="recent-item"><span>${i.name}</span><span class="badge ${b} small">${i.qty}</span></div>`;});checkInventoryHealth();}
        function updateStock(i,c){let it=inventory[i];let n=parseInt(it.qty)+c;if(n<0)return;it.qty=n;localStorage.setItem('inventory',JSON.stringify(inventory));renderInventory();}
        function saveInventory(e){e.preventDefault();const f=new FormData(e.target);inventory.push({name:f.get('name'),category:f.get('category'),qty:parseInt(f.get('qty'))});localStorage.setItem('inventory',JSON.stringify(inventory));renderInventory();closeModal('inventoryModal');e.target.reset();}
        function deleteInventory(i){inventory.splice(i,1);localStorage.setItem('inventory',JSON.stringify(inventory));renderInventory();}
        function checkInventoryHealth(){const l=inventory.filter(i=>i.qty<5).length;const b=document.getElementById('inventoryAlertBox');if(l>0){b.className='alert-status danger';document.getElementById('invAlertTitle').innerText=`${l} Items Low`;document.getElementById('invAlertDesc').innerText="Restock needed.";b.querySelector('i').className='fa-solid fa-triangle-exclamation';}else{b.className='alert-status healthy';document.getElementById('invAlertTitle').innerText="Stock Healthy";document.getElementById('invAlertDesc').innerText="No items running low.";b.querySelector('i').className='fa-solid fa-check';}}
        function renderTasks(){const l=document.getElementById('taskList');l.innerHTML='';if(tasks.length===0){l.innerHTML=`<div class="empty-task"><i class="fa-solid fa-check-circle"></i><p>All caught up!</p></div>`;return;}tasks.sort((a,b)=>new Date(a.date)-new Date(b.date));tasks.forEach((t,i)=>{const d=new Date(t.date);l.innerHTML+=`<div class="task-item"><input type="checkbox" onchange="removeTask(${i})"><div class="task-content"><span class="task-name">${t.desc}</span><span class="task-date"><i class="fa-regular fa-clock"></i> ${d.toLocaleDateString()}</span></div></div>`;});}
        function saveTask(e){e.preventDefault();const f=new FormData(e.target);tasks.push({desc:f.get('desc'),date:f.get('date')});localStorage.setItem('tasks',JSON.stringify(tasks));renderTasks();closeModal('taskModal');e.target.reset();}
        function removeTask(i){setTimeout(()=>{tasks.splice(i,1);localStorage.setItem('tasks',JSON.stringify(tasks));renderTasks();},300);}
        function renderExpenses(){const t=document.getElementById('expenseTable');t.innerHTML='';const s=[...expenses].reverse();s.forEach((x,i)=>{const r=expenses.length-1-i;t.innerHTML+=`<tr><td>${x.date}</td><td>${x.desc}</td><td><span class="badge neutral">${x.category}</span></td><td>$${parseFloat(x.amount).toFixed(2)}</td><td><button onclick="deleteExpense(${r})" class="icon-btn-sm trash"><i class="fa-solid fa-trash"></i></button></td></tr>`;});}
        function saveExpense(e){e.preventDefault();const f=new FormData(e.target);expenses.push({desc:f.get('desc'),category:f.get('category'),amount:f.get('amount'),date:f.get('date')});localStorage.setItem('expenses',JSON.stringify(expenses));renderExpenses();updateCharts();closeModal('expenseModal');e.target.reset();}
        function deleteExpense(i){expenses.splice(i,1);localStorage.setItem('expenses',JSON.stringify(expenses));renderExpenses();updateCharts();}
        function updateCharts(){const c={};let t=0;expenses.forEach(e=>{c[e.category]=(c[e.category]||0)+parseFloat(e.amount);t+=parseFloat(e.amount);});document.getElementById('dashTotalExpense').innerText='$'+t.toFixed(2);const tc=Object.keys(c).reduce((a,b)=>c[a]>c[b]?a:b,'--');document.getElementById('dashTopCat').innerText=tc;const ctx=document.getElementById('expenseChart');const m=document.getElementById('miniExpenseChart');const cfg={type:'doughnut',data:{labels:Object.keys(c),datasets:[{data:Object.values(c),backgroundColor:['#10B981','#3B82F6','#F59E0B','#EF4444','#8B5CF6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'75%',plugins:{legend:{position:'right',labels:{usePointStyle:true,font:{family:"'Plus Jakarta Sans'",size:12}}}}}};if(ctx){if(expenseChartInstance)expenseChartInstance.destroy();expenseChartInstance=new Chart(ctx,cfg);}if(m){new Chart(m,{type:'doughnut',data:cfg.data,options:{responsive:true,maintainAspectRatio:false,cutout:'80%',plugins:{legend:{display:false}}}});}}
        function switchTab(id){document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='finances')updateCharts();}
        function changeLocation(){const c=prompt("City Name:");if(c){localStorage.setItem('preferredCity',c);fetchWeatherByCity(c);}}
        function fetchWeatherByCity(c){fetchData({city:c});}
        function fetchWeatherByGeo(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>fetchData({lat:p.coords.latitude,lon:p.coords.longitude}),()=>document.getElementById('locationName').innerText="Location Denied");}
        async function fetchData(p){try{const r=await fetch('/get-weather',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});const d=await r.json();if(d.success){document.getElementById('locationName').innerText=d.city;renderWeather(d.forecast);renderRain(d.forecast);}}catch(e){}}
        function renderWeather(f){const c=document.getElementById('weatherContainer');c.innerHTML='';const m={'Clear':'fa-sun','Clouds':'fa-cloud','Rain':'fa-cloud-rain','Thunderstorm':'fa-bolt'};f.forEach((d,i)=>{const ic=m[d.desc]||'fa-cloud-sun';const cl=i===0?'weather-card main':'weather-card';c.innerHTML+=`<div class="${cl}"><div class="day">${i===0?'Today':d.day}</div><div class="icon"><i class="fa-solid ${ic}"></i></div><div class="temp">${d.temp}¬∞C</div><div class="rain-badge"><i class="fa-solid fa-umbrella"></i> ${d.rain_chance}%</div></div>`;});}
        function renderRain(f){const c=document.getElementById('rainGrid');c.innerHTML='';f.forEach(d=>{const s=d.rain_chance>50?'danger':'safe';c.innerHTML+=`<div class="rain-row ${s}"><div class="rain-date"><h4>${d.day}</h4><span>${d.desc}</span></div><div class="rain-prob"><div class="prob-bar"><div class="fill" style="width:${d.rain_chance}%"></div></div><span>${d.rain_chance}%</span></div></div>`;});}
        async function handlePredict(e){e.preventDefault();document.getElementById('loader').style.display='block';try{const r=await fetch('/predict',{method:'POST',body:new FormData(e.target)});const d=await r.json();if(d.success){document.querySelector('.empty-state').style.display='none';document.querySelector('.success-state').style.display='block';document.getElementById('predictionResult').innerText=d.result;}}catch(e){}document.getElementById('loader').style.display='none';}
        function resetForm(){document.getElementById('predictForm').reset();document.querySelector('.empty-state').style.display='flex';document.querySelector('.success-state').style.display='none';}
        function handleEnter(e){if(e.key==='Enter')sendMessage();}
    </script>
</body>
</html>